package com.chillbilling.service;

import com.chillbilling.entity.Invoice;
import com.chillbilling.entity.Payment;
import com.chillbilling.exception.BusinessException;
import com.chillbilling.exception.ResourceNotFoundException;
import com.chillbilling.repository.InvoiceRepository;
import com.chillbilling.repository.PaymentRepository;

import java.time.LocalDate;

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
@Transactional
public class PaymentService {

    private final PaymentRepository paymentRepository;
    private final InvoiceRepository invoiceRepository;

    public PaymentService(PaymentRepository paymentRepository, InvoiceRepository invoiceRepository) {
        this.paymentRepository = paymentRepository;
        this.invoiceRepository = invoiceRepository;
    }

    public Payment recordPayment(PaymentRequest request) {
        // 1. Find invoice
        Invoice invoice = invoiceRepository.findById(request.getInvoiceNumber())
                .orElseThrow(() -> new ResourceNotFoundException(
                        "Invoice not found with number: " + request.getInvoiceNumber()));

        // 2. Validate amount (only for SUCCESS payments)
        if (request.getStatus() == Payment.Status.SUCCESS) {
            if (request.getAmount() <= 0) {
                throw new BusinessException("Payment amount must be greater than 0.");
            }
            if (request.getAmount() > invoice.getBalance()) {
                throw new BusinessException("Payment amount cannot exceed remaining balance.");
            }
        }

        // 3. Create payment entry
        Payment payment = new Payment();
        payment.setInvoice(invoice);
        payment.setAmount(request.getAmount());
        payment.setMethod(request.getMethod());
        payment.setStatus(request.getStatus());
        payment.setTransactionId(request.getTransactionId());
        payment.setPaymentDate(request.getPaymentDate() != null 
                ? request.getPaymentDate() 
                : java.time.LocalDateTime.now());

        paymentRepository.save(payment);

        // 4. Update invoice amounts ONLY if payment is SUCCESS
        if (request.getStatus() == Payment.Status.SUCCESS) {
            double newPaidAmount = invoice.getPaidAmount() + request.getAmount();
            double newBalance = invoice.getTotalAmount() - newPaidAmount;

            invoice.setPaidAmount(newPaidAmount);
            invoice.setBalance(newBalance);

            // 5. Update invoice status
            if (newBalance == 0) {
                invoice.setStatus(Invoice.Status.PAID);
            } else if (newPaidAmount == 0) {
                // No payment made
                if (invoice.getDueDate().isBefore(java.time.LocalDate.now())) {
                    invoice.setStatus(Invoice.Status.OVERDUE);
                } else {
                    invoice.setStatus(Invoice.Status.UNPAID);
                }
            } else {
                // Partial payment made
                if (invoice.getDueDate().isBefore(java.time.LocalDate.now())) {
                    invoice.setStatus(Invoice.Status.OVERDUE);
                } else {
                    invoice.setStatus(Invoice.Status.PARTIALLY_PAID);
                }
            }

        }

        invoiceRepository.save(invoice);
        return payment;
    }
}
